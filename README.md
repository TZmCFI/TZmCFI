# TZmCFI prototype implementation

<center><img src="docs/banner.jpg"></center>

## Prerequisite

- Either of the following:
    - [QEMU] 4.0.0 or later. Older versions are not tested but might work.
    - Arm [MPS2+] FPGA prototyping board configured with AN505. The encrypted FPGA image of AN505 is available from [Arm's website].
- Zig [`2cb1f93`](https://github.com/ziglang/zig/commit/2cb1f93894be3f48f0c49004515fa5e8190f69d9) (Aug 16, 2019) or later
- [Rust](https://www.rust-lang.org/en-US/) 1.31.0 or later.

[QEMU]: https://www.qemu.org
[MPS2+]: https://www.arm.com/products/development-tools/development-boards/mps2-plus
[Arm's website]: https://developer.arm.com/tools-and-software/development-boards/fpga-prototyping-boards/download-fpga-images?_ga=2.138343728.123477322.1561466661-1332644519.1559889185

## Running the example application

    $ cargo +nightly build --all

    $ cd examples
    $ zig build -Drelease-small qemu:rtosbasic
    (^A-X to quit)

The supported build options that can be passed to `zig build` are listed below:

### `-Dgdb` — Build for debugging

The `-Dgdb` option causes qemu to stop until GDB conenction. Do the following to attach a debugger:

    $ arm-none-eabi-gdb zig-cache/secure -ex "target remote 127.0.0.1:1234"

This option also changes the output filenames for no reason. (TODO: Remove this behabviour?)

### `-Dcfi=false` — Disable CFI hooks

As the name implies, it disables the control flow integrity mechanism. Useful for comparative experiments.

### `-Dtrace` — Enable tracing

Enable TZmCFI's tracing output generated by `warn` function. This is useful for debugging.

This option only controls whether a trace handler is registered or not. LLVM's LTO is resposible for removing tracing calls when tracing is disabled.

### Standard build modes

Zig defines four standard build modes (at the point of writing), which you can choose via one of the following command-line options (the descriptions are taken from [Zig's website]):

|       Parameter        | Debug (default) | `-Drelease-safe` | `-Drelease-fast` | `-Drelease-small` |
|------------------------|-----------------|------------------|------------------|-------------------|
| Optimizations¹         |                 | `-O3`            | `-O3`            | `-Os`             |
| Runtime safety checks² | On              | On               |                  |                   |

¹ improve speed, harm debugging, harm compile time

² harm speed, harm size, crash instead of undefined behavior

[Zig's website]: https://ziglang.org/#Performance-and-Safety-Choose-Two
