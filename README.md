# TZmCFI prototype implementation

<center><img src="docs/banner.jpg"></center>

## Prerequisite

- Any of the following:
    - [QEMU] 4.0.0 or later. Older versions are not tested but might work.
    - Arm [MPS2+] FPGA prototyping board configured with AN505. The encrypted FPGA image of AN505 is available from [Arm's website].
    - An [LPCXpresso55S69](https://www.nxp.com/products/processors-and-microcontrollers/arm-microcontrollers/general-purpose-mcus/lpc5500-cortex-m33/lpcxpresso55s69-development-board:LPC55S69-EVK) development board.
- To enable the compiler-level CFI scheme:
    - [Our custom fork of Zig](https://github.com/TZmCFI/zig/tree/eca1091026e53172929b63f3a56bff3892b3cebd)
    - [Our custom fork of LLVM](https://github.com/TZmCFI/llvm-project/tree/3e75d0cd964199a3420a780e7ae2bd526bff8171)
- If you don't want the compiler-level CFI scheme, you still need:
    - Zig 0.6.0 (TODO: Confirm this)
- [Rust](https://www.rust-lang.org/en-US/) 1.38.0 or later.

[QEMU]: https://www.qemu.org
[MPS2+]: https://www.arm.com/products/development-tools/development-boards/mps2-plus
[Arm's website]: https://developer.arm.com/tools-and-software/development-boards/fpga-prototyping-boards/download-fpga-images?_ga=2.138343728.123477322.1561466661-1332644519.1559889185

## Running the example application

    $ cargo build --all

    $ cd examples
    $ zig build -Drelease-small qemu:rtosbasic
    (^A-X to quit)

The supported build options that can be passed to `zig build` are listed below:

### `-Dgdb` — Build for debugging

The `-Dgdb` option causes qemu to stop until GDB conenction. Do the following to attach a debugger:

    $ arm-none-eabi-gdb zig-cache/secure -ex "target remote 127.0.0.1:1234"

This option also changes the output filenames for no reason. (TODO: Remove this behabviour?)

### `-Dcfi[-type]={true|false}` — Toggle CFI mechanisms

As the name implies, it enables or disables the control flow integrity mechanism. Useful for comparative experiments. The following mechanisms are implemented:

- `-Dcfi-ctx` toggles the use of TZmCFI context management API. This is technically not a CFI mechanism, but is a prerequisite for other mechanisms.
- `-Dcfi-ses` toggles TZmCFI shadow exception stacks (a specialized variant of traditional shadow stacks for interrupt handling).
- `-Dcfi-ss` toggles TZmCFI shadow stacks.
- `-Dcfi-icall` toggles LLVM indirect call sanitizer.
- `-Dcfi` toggles all mechanisms listed above.

There is the following configurable option:

- `-Dcfi-aborting-ss` toggles the uses of the aborting implementation of TZmCFI shadow stacks. The aborting implementation validates the integrity of a non-trustworthy return address, hence an increased overhead, whereas the default implementation just reloads and uses a trustworthy return address.
- `-Dcfi-unnest` disables the support for nested exceptions, substantially reducing the overhead of shadow exception stacks.

### `-Dlog-{none|critical|warning|trace}` — Set log level

Changes the verbosity of TZmCFI's tracing output generated by `log` function. This is useful for debugging.

This option controls `@import("root").TC_LOG_LEVEL`.

### `-Dprofile` — Enable profiler

Enable the collection of statistical information. The profiler API must be used to actually utilize the profiler. The collected information is logged with level `Critical` when `TCDebugDumpProfile` is called.

This option controls `@import("root").TC_ENABLE_PROFILER`.

### `-Daccel-raise-pri={false|true}` — `portRAISE_PRIVILEGE` acceleration

When enabled, `portRAISE_PRIVILEGE()` is replaced with a TrustZone-based implementation that is simpler and more performant than the original, traditional implementation. This drastically cuts down (by about 200 cycles) the runtime overhead of FreeRTOS system calls incurred by shadow exception stacks.

### Standard build modes

Zig defines four standard build modes (at the point of writing), which you can choose via one of the following command-line options (the descriptions are taken from [Zig's website]):

|       Parameter        | Debug (default) | `-Drelease-safe` | `-Drelease-fast` | `-Drelease-small` |
|------------------------|-----------------|------------------|------------------|-------------------|
| Optimizations¹         |                 | `-O3`            | `-O3`            | `-Os`             |
| Runtime safety checks² | On              | On               |                  |                   |

¹ improve speed, harm debugging, harm compile time

² harm speed, harm size, crash instead of undefined behavior

[Zig's website]: https://ziglang.org/#Performance-and-Safety-Choose-Two
